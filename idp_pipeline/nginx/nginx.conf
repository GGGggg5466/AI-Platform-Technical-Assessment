worker_processes  auto;

events { worker_connections 1024; }

http {
  include       /etc/nginx/mime.types;
  default_type  application/json;

  # log format（方便你截圖寫報告）
  log_format main '$remote_addr - $remote_user [$time_local] '
                  '"$request" $status $body_bytes_sent '
                  '"$http_referer" "$http_user_agent" '
                  'rt=$request_time uct=$upstream_connect_time '
                  'urt=$upstream_response_time uht=$upstream_header_time';

  access_log /var/log/nginx/access.log main;
  error_log  /var/log/nginx/error.log warn;

  # === Rate limit zones（按 client IP）===
  # 一般 API：10 req/s，允許 burst 20（短時間突發）
  limit_req_zone $binary_remote_addr zone=api_rps:10m rate=10r/s;

  # /v1/jobs 建立 job：更嚴格一點 3 req/s（避免被狂打）
  limit_req_zone $binary_remote_addr zone=jobs_rps:10m rate=3r/s;

  # 連線數限制（同 IP 同時連線）
  limit_conn_zone $binary_remote_addr zone=perip_conn:10m;
  limit_req_status 429;
  limit_req_log_level notice;

  # === Upstream（被動健康檢查）===
  upstream idp_api_upstream {
    # 你本機跑 uvicorn:8000 -> 用 host.docker.internal 轉接
    # max_fails/fail_timeout 是被動健康檢查：連續失敗就暫時標記 down
    server host.docker.internal:8000 max_fails=3 fail_timeout=10s;
    keepalive 32;
  }

  server {
    listen 80;
    client_max_body_size 50m;

    # Gateway 自己的健康檢查（不用打到後端）
    location = /health {
      return 200 '{"status":"ok","component":"nginx-gateway"}';
    }

    # 可選：Nginx stub_status（想做截圖也很加分）
    location = /nginx_status {
      stub_status;
      allow 127.0.0.1;
      deny all;
    }

    # /v1/jobs（建立工作）做更嚴格 rate limit
    location = /v1/jobs {
      limit_req zone=jobs_rps burst=10 nodelay;
      limit_conn perip_conn 20;

      proxy_http_version 1.1;
      proxy_set_header Connection "";

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_connect_timeout 2s;
      proxy_read_timeout 120s;
      proxy_send_timeout 120s;

      # 被動健康檢查 + failover 行為
      proxy_next_upstream error timeout http_502 http_503 http_504;
      proxy_next_upstream_tries 2;

      proxy_pass http://idp_api_upstream;
    }

    # ✅ GraphRAG 專用：更保守的連線數 + 較合理的 timeout
    location = /v1/graphrag {
      # （可選）你也可以給 GraphRAG 更嚴格的 RPS
      limit_req zone=api_rps burst=10 nodelay;

      # ✅ 1) 同 IP 同時最多 5 條連線打 GraphRAG（減少後端被打爆→504）
      limit_conn perip_conn 5;

      proxy_http_version 1.1;
      proxy_set_header Connection "";

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      # ✅ 2)~4) 三個 timeout（這就是你問的那三個）
      proxy_connect_timeout 5s;   # 跟後端建立連線最多等 5 秒
      proxy_read_timeout 60s;     # 後端回應慢時最多等 60 秒（GraphRAG/LLM 常用）
      proxy_send_timeout 60s;     # 送資料給後端最多等 60 秒（通常不會卡，但留著穩）

      proxy_next_upstream error timeout http_502 http_503 http_504;
      proxy_next_upstream_tries 2;

      proxy_pass http://idp_api_upstream;
    }


    # 其餘 /v1/* API：一般 rate limit
    location ^~ /v1/ {
      limit_req zone=api_rps burst=20 nodelay;
      limit_conn perip_conn 50;

      proxy_http_version 1.1;
      proxy_set_header Connection "";

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_connect_timeout 2s;
      proxy_read_timeout 120s;
      proxy_send_timeout 120s;

      proxy_next_upstream error timeout http_502 http_503 http_504;
      proxy_next_upstream_tries 2;

      proxy_pass http://idp_api_upstream;
    }

    # 非 /v1 路徑（例如 /docs /openapi.json）也一起反代，方便驗收
    location / {
      limit_req zone=api_rps burst=20 nodelay;
      limit_conn perip_conn 50;

      proxy_http_version 1.1;
      proxy_set_header Connection "";

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_connect_timeout 2s;
      proxy_read_timeout 120s;

      proxy_next_upstream error timeout http_502 http_503 http_504;
      proxy_next_upstream_tries 2;

      proxy_pass http://idp_api_upstream;
    }
  }
}